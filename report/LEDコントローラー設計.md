



## 発行パターン周期設定

最長：1/30      30fps   => 33.33... ms
最短：1/10,000  10kfps  => 100us 


クロック周期

3.33 MHz(300.3...[ns])

100us : 333カウント
10fps : 111000カウント（0x1B198）




bit[31]
bit[30]
bit[29]
bit[28]
bit[27]
bit[26]
bit[25]
bit[24]
bit[23:0]



## FPGA間インタフェース

- パラメータ変化通達：トグル信号
- 列遷移信号   ：トグル信号
- モード        ：ライン・ポイント
- イネーブル    ：

-------------------------------------------------
# FPGAでシンプルSPI受信

ESP32マイコンをSPIマスター，FPGAをSPIスレーブとして受信のみを行うVerilogソースを紹介します.

## 設計指針
- 初心者向けになるべく簡素にしました．
- SPIのMOSI受信動作のみで,MISO応答は返しません．
- グローバルクロック同期設計
- メタステーブル対策あり

## 入力仕様
SPI入力信号

項目 | 仕様　| 備考
-----|------|--------
FPGAグローバルクロック  | 10.64MHz      | Lattic製 MachXO2の内臓PLLモジュール(OSCH)を使用
SPIクロック周波数       |1MHz           |1us周期
Byteオーダー            |MSBファースト  |
データ長                |32bit          |ESP32の**SPI.transfer32**関数を使用
SPIモード               |クロック待機時　High<br>　データサンプリング 立上り|ESP32の設定は**SPI.setDataMode(SPI_MODE3)**
チップセレクト          |Low有意　|

## 出力仕様
- 32bit受信データをパラレル出力します.
- SPIチップセレクトの立上りを検出し，パラレル出力の有効を示すValid信号を１サイクルアサートします.


## 設計ポイント
### グローバルクロック同期設計
FPGA設計のセオリーに従って，全てのフリップフロップはグローバルクロックに同期するように設計します．
つまり，SPI_CLKはクロックとして使用せずに入力信号として設計します．
この場合，**グローバルクロックがSPIクロックより十分に早い**ことが必須になります．
1MHzのSPIクロックに対して約10倍早い10.64MMzのグローバルクロックを使用しているので，本回路構成は成立します．

### メタステーブル対策
メタステーブルについての説明は割愛しますが，グローバルクロックに同期した後の信号のみを使用します．
入力ポートから入ってきた信号はただの２段D-FFを通過させた後に，組み合わせ回路に接続する構成としています.

## Verilogソースコード

## RTL図
Verilogソースコードを近似したRTL図で表現しました．
条件文の部分のRTL図表現は多少簡略化していますが，FFの前後関係見れば回路構成の理解に役立つかと思います．